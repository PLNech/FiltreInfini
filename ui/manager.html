<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FiltreInfini - Tab Manager</title>
  <link rel="stylesheet" href="styles/base.css">
  <link rel="stylesheet" href="styles/components.css">
  <link rel="stylesheet" href="styles/layouts.css">
</head>
<body>
  <div class="app">
    <!-- Model Loading Progress Toast -->
    <div id="model-loading-toast" style="display: none; position: fixed; top: 10px; right: 10px; background: white; border: 2px solid #4CAF50; border-radius: 8px; padding: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 9999; max-width: 400px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <h3 style="margin: 0; font-size: 14px; font-weight: 600;">ğŸ§  Loading ML Models</h3>
        <button id="close-toast-btn" style="background: none; border: none; font-size: 20px; cursor: pointer; padding: 0; line-height: 1;">Ã—</button>
      </div>
      <div id="model-progress-list" style="font-size: 13px; color: #666;"></div>
    </div>

    <header class="header">
      <h1 class="header__title">FiltreInfini</h1>
      <div class="header__actions">
        <button id="analysis-view-btn" class="btn btn--primary" title="View detailed tab analysis with charts and filters">ğŸ“Š Analysis View</button>
        <button id="settings-btn" class="btn btn--secondary" title="History integration & privacy settings">âš™ï¸ Settings</button>
        <button id="import-sync-btn" class="btn btn--secondary" title="Import Firefox Sync tabs">ğŸ“¥ Import Synced Tabs</button>
        <input type="file" id="sync-file-input" accept=".json" style="display: none;">
        <button id="export-btn" class="btn btn--secondary">ğŸ“¤ Export CSV</button>
        <button id="fetch-all-btn" class="btn btn--tertiary" title="Reload all metadata">ğŸ”„ Refresh Metadata</button>
        <button id="classify-all-btn" class="btn btn--tertiary" title="Run ML classification on all tabs">ğŸ§  Classify All</button>
      </div>    </header>

    <main class="main">
      <!-- Query Input Section -->
      <section class="query-section">
        <label for="query-input" class="query-section__label">Search:</label>
        <div class="search-input-wrapper">
          <input
            type="text"
            id="query-input"
            class="query-section__input"
            placeholder="claude memory age>1w  (text + filters: >, >=, <, <=, =; units: d, w, m, y, today)"
            autocapitalize="off"
            autocorrect="off"
          >
          <button id="clear-query-btn" class="clear-input-btn" title="Clear search" style="display: none;">Ã—</button>
        </div>
      </section>

      <!-- Quick Filters -->
      <section class="filters-section">
        <h2 class="filters-section__title">Quick Filters</h2>
        <div class="filters-section__group">
          <h3 class="filters-section__subtitle">By Age</h3>
          <div class="filters-section__buttons">
            <button class="filter-btn" data-filter="all">All Tabs</button>
            <button class="filter-btn" data-filter="week">1 Week+</button>
            <button class="filter-btn" data-filter="forgotten">2 Weeks+</button>
            <button class="filter-btn" data-filter="ancient">1 Month+</button>
            <button class="filter-btn" data-filter="6months">6 Months+</button>
            <button class="filter-btn" data-filter="1year">1 Year+</button>
            <button class="filter-btn" data-filter="2years">2 Years+</button>
            <button class="filter-btn" data-filter="3years">3 Years+</button>
          </div>
        </div>
        <div class="filters-section__group">
          <h3 class="filters-section__subtitle">By Category</h3>
          <div class="filters-section__buttons">
            <button class="category-filter-btn" data-category="tech">ğŸ’» Tech</button>
            <button class="category-filter-btn" data-category="reading">ğŸ“š Reading</button>
            <button class="category-filter-btn" data-category="videos">ğŸ¬ Videos</button>
            <button class="category-filter-btn" data-category="sorties">ğŸ­ Sorties</button>
            <button class="category-filter-btn" data-category="shopping">ğŸ›’ Shopping</button>
            <button class="category-filter-btn" data-category="social">ğŸ’¬ Social</button>
            <button class="category-filter-btn" data-category="work">ğŸ’¼ Work</button>
          </div>
        </div>
        <div class="filters-section__group">
          <h3 class="filters-section__subtitle">Special</h3>
          <div class="filters-section__buttons">
            <button class="filter-btn" data-filter="internal">ğŸ”§ Internal (browser pages)</button>
            <button class="filter-btn" data-filter="broken">âš ï¸ Broken (4xx/5xx)</button>
          </div>
        </div>
        <div class="filters-section__group">
          <h3 class="filters-section__subtitle">By Source</h3>
          <div class="filters-section__buttons">
            <button class="source-filter-btn" data-source="all">ğŸ“‹ All Tabs</button>
            <button class="source-filter-btn" data-source="local">ğŸ’» Local Only</button>
            <button class="source-filter-btn" data-source="synced">ğŸ“± Synced Only</button>
          </div>
        </div>
      </section>

      <!-- Statistics -->
      <section class="stats-section">
        <div class="stat-card">
          <span class="stat-card__label">Total</span>
          <span id="stat-total" class="stat-card__value">0</span>
        </div>
        <div class="stat-card stat-card--main">
          <span class="stat-card__label">Main</span>
          <span id="stat-main" class="stat-card__value">0</span>
        </div>
        <div class="stat-card stat-card--staging">
          <span class="stat-card__label">Staging</span>
          <span id="stat-staging" class="stat-card__value">0</span>
        </div>
        <div class="stat-card stat-card--bin">
          <span class="stat-card__label">Bin</span>
          <span id="stat-bin" class="stat-card__value">0</span>
        </div>
      </section>

      <!-- View Switcher -->
      <section class="view-switcher">
        <button id="view-list-btn" class="view-switcher__btn active">ğŸ“‹ List View</button>
        <button id="view-groups-btn" class="view-switcher__btn">ğŸ´ Groups View</button>
      </section>

      <!-- Tab List -->
      <section id="list-view" class="tabs-section">
        <div class="tabs-section__header">
          <h2 class="tabs-section__title">Tabs (<span id="tabs-count">0</span>)</h2>
          <div class="tabs-section__controls">
            <select id="sort-select" class="sort-select">
              <option value="lastAccessed">Sort: Last Accessed (Recent)</option>
              <option value="lastAccessed-asc">Sort: Last Accessed (Oldest)</option>
              <option value="title">Sort: Title (A-Z)</option>
              <option value="domain">Sort: Domain (A-Z)</option>
              <option value="age">Sort: Age (Newest)</option>
              <option value="age-desc">Sort: Age (Oldest)</option>
            </select>
            <div class="tabs-section__bulk-actions">
              <button id="bulk-main-btn" class="btn btn--small">â†’ Main</button>
              <button id="bulk-staging-btn" class="btn btn--small">â†’ Staging</button>
              <button id="bulk-bin-btn" class="btn btn--small">â†’ Bin</button>
              <button id="bulk-close-btn" class="btn btn--small btn--danger">Close</button>
            </div>
          </div>
        </div>

        <div id="tabs-list" class="tabs-list">
          <!-- Tabs will be dynamically inserted here -->
        </div>
      </section>

      <!-- Groups View -->
      <section id="groups-view" class="groups-section" style="display: none;">
        <div class="groups-section__header">
          <h2 class="groups-section__title">Groups (<span id="groups-count">0</span> domains)</h2>
        </div>
        <div id="groups-container" class="groups-masonry">
          <!-- Domain cards will be dynamically inserted here -->
        </div>
      </section>
    </main>
  </div>

  <!-- Details Modal -->
  <div id="details-modal" class="modal" style="display: none;">
    <div class="modal__overlay"></div>
    <div class="modal__content">
      <div class="modal__header">
        <h2 class="modal__title" id="modal-title">Tab Details</h2>
        <button class="modal__close" id="modal-close-btn">Ã—</button>
      </div>
      <div class="modal__body" id="modal-body">
        <div class="loading">Loading metadata...</div>
      </div>
    </div>
  </div>

  <!-- Import Guidance Modal -->
  <div id="import-guide-modal" class="modal" style="display: none;">
    <div class="modal__overlay"></div>
    <div class="modal__content modal__content--wide">
      <div class="modal__header">
        <h2 class="modal__title">Import Synced Tabs from Firefox</h2>
        <button class="modal__close" id="import-guide-close-btn">Ã—</button>
      </div>
      <div class="modal__body">
        <p>Firefox Android has a limitation where browser.tabs.query() only returns loaded tabs. To work around this, you can import tabs from Firefox Sync data.</p>

        <h3>Steps to Extract Synced Tabs:</h3>
        <ol>
          <li>Open Firefox on your desktop computer</li>
          <li>Press <kbd>Ctrl+Shift+K</kbd> (or <kbd>Cmd+Opt+K</kbd> on Mac) to open the Web Console</li>
          <li>Copy and paste the following script into the console:</li>
        </ol>

        <div class="code-block">
          <pre id="sync-extraction-script">SyncedTabs._internal.getTabClients().then(arrDevices => {
  const json = JSON.stringify(arrDevices, null, 2);
  const blob = new Blob([json], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'synced-tabs-' + Date.now() + '.json';
  a.click();
  URL.revokeObjectURL(url);
  console.log('Downloaded!');
});</pre>
          <button id="copy-script-btn" class="btn btn--small" style="margin-top: 8px;">ğŸ“‹ Copy Script</button>
        </div>

        <ol start="4">
          <li>Press <kbd>Enter</kbd> to execute the script</li>
          <li>A file named <code>synced-tabs-TIMESTAMP.json</code> will be downloaded</li>
          <li>Click the "Choose File" button below to import it</li>
        </ol>

        <div style="margin-top: 20px; text-align: center;">
          <button id="choose-file-btn" class="btn btn--primary">Choose File to Import</button>
        </div>

        <div class="info-box" style="margin-top: 20px;">
          <strong>Note:</strong> This data includes URLs, titles, and device names from your synced Firefox instances. The file stays on your device and is never uploaded anywhere.
        </div>
      </div>
    </div>
  </div>

  <!-- ML Debug Modal -->
  <div id="ml-debug-modal" class="modal" style="display: none;">
    <div class="modal__overlay"></div>
    <div class="modal__content modal__content--wide">
      <div class="modal__header">
        <h2 class="modal__title">ğŸ¤– ML Classification Debug</h2>
        <button class="modal__close" id="ml-debug-close-btn">Ã—</button>
      </div>
      <div class="modal__body">
        <p style="margin-bottom: 20px;">Test the 3D ML classification system with example tabs. Edit the JSON below or use presets.</p>

        <!-- Model Testing -->
        <div style="margin-bottom: 20px;">
          <h3 style="margin-bottom: 10px;">Test Individual Models:</h3>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="btn btn--small" id="test-embeddings-btn">ğŸ“Š Test Embeddings</button>
            <button class="btn btn--small" id="test-classification-btn">ğŸ¯ Test Classification</button>
            <button class="btn btn--small" id="test-ner-btn">ğŸ”– Test NER</button>
            <button class="btn btn--small" id="check-model-cache-btn">ğŸ’¾ Check Cache</button>
          </div>
        </div>

        <!-- Presets -->
        <div style="margin-bottom: 20px;">
          <h3 style="margin-bottom: 10px;">Quick Presets:</h3>
          <button class="btn btn--small ml-preset-btn" data-preset="tech">ğŸ’» Tech Docs</button>
          <button class="btn btn--small ml-preset-btn" data-preset="shopping">ğŸ›’ Shopping</button>
          <button class="btn btn--small ml-preset-btn" data-preset="social">ğŸ’¬ Social</button>
          <button class="btn btn--small ml-preset-btn" data-preset="news">ğŸ“° News</button>
          <button class="btn btn--small ml-preset-btn" data-preset="old">ğŸ“š Old Reference</button>
          <button class="btn btn--small ml-preset-btn" data-preset="mixed">ğŸ² Mixed Batch</button>
        </div>

        <!-- Tab Input -->
        <div style="margin-bottom: 20px;">
          <h3 style="margin-bottom: 10px;">Tab Data (JSON):</h3>
          <textarea id="ml-tab-input" style="width: 100%; height: 200px; font-family: monospace; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
{
  "id": "test-1",
  "title": "Python Tutorial - Learn Python Programming",
  "url": "https://docs.python.org/3/tutorial/",
  "domain": "docs.python.org",
  "lastUsed": 1234567890,
  "inactive": false
}
          </textarea>
        </div>

        <!-- Action Buttons -->
        <div style="margin-bottom: 20px; display: flex; gap: 10px;">
          <button id="ml-classify-single-btn" class="btn btn--primary">ğŸ”¬ Classify Single Tab</button>
          <button id="ml-classify-batch-btn" class="btn btn--secondary">ğŸ“Š Classify Batch (Array)</button>
          <button id="ml-test-context-btn" class="btn btn--tertiary">ğŸ§  Test Context Features</button>
        </div>

        <!-- Results -->
        <div id="ml-results" style="display: none;">
          <h3 style="margin-bottom: 10px;">Results:</h3>
          <div id="ml-results-content" style="background: #f5f5f5; padding: 15px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto;"></div>
        </div>

        <!-- Loading -->
        <div id="ml-loading" style="display: none; text-align: center; padding: 20px;">
          <p>â³ Loading model (~67MB, cached after first load)...</p>
          <p style="font-size: 0.9em; color: #666;">This may take 10-30 seconds on first run</p>
        </div>

        <!-- Status -->
        <div id="ml-status" style="margin-top: 20px; padding: 10px; background: #e3f2fd; border-radius: 4px; display: none;"></div>
      </div>
    </div>
  </div>

  <!-- Load libraries and main script -->
  <script src="../lib/storage.js"></script>
  <script src="../lib/group-manager.js"></script>
  <script src="../lib/metadata-storage.js"></script>
  <script src="../lib/metadata-manager.js"></script>
  <script src="../lib/query-parser.js"></script>
  <script src="../lib/tab-query.js"></script>
  <script src="../lib/export.js"></script>
  <script src="../lib/brand-colors.js"></script>
  <script src="../lib/categorizer.js"></script>
  <script src="../lib/sync-parser.js"></script>
  <script src="../lib/domain-knowledge.js"></script>
  <script src="../lib/context-features.js"></script>
  <script src="../lib/feedback-manager.js"></script>

  <!-- ML Model Pre-loader -->
  <script src="../lib/model-preloader.js"></script>

  <!-- ML classification runs in background worker (see background/ml-worker.js) -->
  <!-- Models are pre-loaded in UI context (better fetch limits) then cached for background worker -->
  <!-- Context features are still needed in UI for extracting session context -->

  <script src="manager.js"></script>
</body>
</html>
